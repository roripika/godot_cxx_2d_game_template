# Mystery scenario (planner-authored)
# This YAML is parsed by Basic Game Karakuri (C++ GDExtension).
#
# Supported YAML subset: maps, sequences, simple scalars.

start_scene: office

scenes:
  office:
    scene_path: res://samples/mystery/office_base.tscn
    on_enter:
      - dialogue:
          speaker: Boss
          text_key: office_boss_intro
    hotspots:
      door:
        node_id: hs_door
        on_click:
          - dialogue:
              speaker: System
              text_key: office_system_going_to_warehouse
          - goto: warehouse
      boss:
        node_id: hs_boss
        on_click:
          - if_flag:
              key: all_evidence_collected
              value: true
              then:
                - dialogue:
                    speaker: Boss
                    text_key: deduction_title
                - goto: deduction
              else:
                - dialogue:
                    speaker: Boss
                    text_key: office_boss_go_warehouse

  warehouse:
    scene_path: res://samples/mystery/warehouse_base.tscn
    on_enter:
      - dialogue:
          speaker: System
          text_key: warehouse_intro
    hotspots:
      floor_area:
        node_id: hs_floor_area
        on_click:
          - dialogue:
              speaker: Detective
              text_key: hotspot_floor_area
          - give_evidence: ectoplasm
          - dialogue:
              speaker: System
              text_key: evidence_found
      footprints:
        node_id: hs_footprints
        on_click:
          - dialogue:
              speaker: Detective
              text_key: hotspot_footprints
          - give_evidence: footprint
          - dialogue:
              speaker: System
              text_key: evidence_found
      memo:
        node_id: hs_memo
        on_click:
          - dialogue:
              speaker: Detective
              text_key: hotspot_memo
          - give_evidence: torn_memo
          - dialogue:
              speaker: System
              text_key: evidence_found
      exit:
        node_id: hs_exit
        on_click:
          - if_has_items:
              items:
                - ectoplasm
                - footprint
                - torn_memo
              then:
                - set_flag:
                    key: all_evidence_collected
                    value: true
                - dialogue:
                    speaker: System
                    text_key: investigation_complete
                - goto: office
              else:
                - dialogue:
                    speaker: System
                    text_key: need_more_evidence

  deduction:
    scene_path: res://samples/mystery/office_deduction_base.tscn
    on_enter:
      - dialogue:
          speaker: Boss
          text_key: deduction_title
      - dialogue:
          speaker: Detective
          text_key: deduction_question
      - choice:
          choices:
            - option:
                text_key: deduction_choice1
                actions:
                  - set_flag:
                      key: deduction_complete
                      value: true
                  - dialogue:
                      speaker: Boss
                      text_key: deduction_correct
                  - goto: confrontation
            - option:
                text_key: deduction_choice2
                actions:
                  - take_damage: 1
                  - dialogue:
                      speaker: Boss
                      text_key: deduction_wrong
                  - if_health_leq:
                      value: 0
                      then:
                        - set_flag:
                            key: game_over
                            value: true
                        - goto: ending
                      else:
                        - goto: confrontation
            - option:
                text_key: deduction_choice3
                actions:
                  - take_damage: 1
                  - dialogue:
                      speaker: Boss
                      text_key: deduction_wrong
                  - if_health_leq:
                      value: 0
                      then:
                        - set_flag:
                            key: game_over
                            value: true
                        - goto: ending
                      else:
                        - goto: confrontation

  confrontation:
    scene_path: res://samples/mystery/warehouse_confrontation_base.tscn
    on_enter:
      - dialogue:
          speaker: System
          text_key: confrontation_intro
      - testimony:
          max_rounds: 1
          testimonies:
            - line:
                speaker: 容疑者
                text_key: testimony_1
                evidence: footprint
                shake_key: press_response
            - line:
                speaker: 容疑者
                text_key: testimony_2
                evidence: torn_memo
                shake_key: press_response
            - line:
                speaker: 容疑者
                text_key: testimony_3
                evidence: ectoplasm
                shake_key: press_response
          on_success:
            - set_flag:
                key: case_solved
                value: true
            - if_flag:
                key: all_evidence_collected
                value: true
                then:
                  - if_health_ge:
                      value: 3
                      then:
                        - set_flag:
                            key: perfect_ending
                            value: true
            - goto: ending
          on_failure:
            - set_flag:
                key: game_over
                value: true
            - goto: ending

  ending:
    scene_path: res://samples/mystery/ending_base.tscn
    on_enter:
      - if_flag:
          key: game_over
          value: true
          then:
            - dialogue:
                speaker: Boss
                text_key: ending_failure
          else:
            - if_flag:
                key: perfect_ending
                value: true
                then:
                  - dialogue:
                      speaker: Boss
                      text_key: ending_perfect
                else:
                  - if_flag:
                      key: case_solved
                      value: true
                      then:
                        - dialogue:
                            speaker: Boss
                            text_key: ending_normal
                      else:
                        - dialogue:
                            speaker: Boss
                            text_key: ending_failure
      - choice:
          choices:
            - option:
                text_key: ending_choice_retry
                actions:
                  - reset_game: true
                  - goto: office
            - option:
                text_key: ending_choice_menu
                actions:
                  - reset_game: true
                  - change_root_scene: res://samples/main_menu.tscn
